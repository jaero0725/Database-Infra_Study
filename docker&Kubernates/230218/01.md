# 20230218 1주차 강의
## 환경 구성 

### 가성머신 설치
- 리눅스  - centos 7버전 이상 / ubuntu 18.04 ~ 22.x 버전 이상 사용 

- Ubuntu Bionic 18.04 (LTS)
- https://docs.docker.com/engine/install/ubuntu/
- https://www.virtualbox.org/wiki/Download_Old_Builds - virtualbox 다운로드 
- https://hub.docker.com/

### vagrant 설치 
* vagrant 
-  https://www.vagrantup.com/ => AMD64 다운로드
- 다운로드 후 버전 확인 

~~
vagrant image 를 활용하여 docker 설치
mswindow 에서 powershell 실행후
임의의 디렉토리 생성후 아래처럼 파일 다운로드

wget http://twoseven.kr/weekend_0218/docker_vm/Vagrantfile -Outfile Vagrantfile
wget http://twoseven.kr/weekend_0218/docker_vm/docker_install.sh -Outfile docker_install.sh
wget http://twoseven.kr/weekend_0218/docker_vm/ssh_conf.sh -Outfile ssh_conf.sh

그다음 파일을 다운로드 받은 디렉토리 안에서 vagrant up 실행
~~

``` shell
C:\WINDOWS\system32> vagrant version 
```
- cpu 가상화가 bios에서 켜져있어야됨 <br>
- cmos setup 

vagarnt에서는 box 
https://app.vagrantup.com/boxes/search?utf8=%E2%9C%93&sort=downloads&provider=&q=ubuntu22

``` shell

PS C:\Users\dhqkg> mkdir docker_ubuntu
PS C:\Users\dhqkg> cd week
PS C:\Users\dhqkg\week> mkdir docker_ubuntu

PS C:\Users\dhqkg\week\docker_ubuntu> vagrant init generic/ubuntu2204
A `Vagrantfile` has been placed in this directory. You are now
ready to `vagrant up` your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
`vagrantup.com` for more information on using Vagrant.
PS C:\Users\dhqkg\week\docker_ubuntu> vagrant init generic/ubuntu2204
`Vagrantfile` already exists in this directory. Remove it before
running `vagrant init`.
PS C:\Users\dhqkg\week\docker_ubuntu> vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
==> default: Box 'generic/ubuntu2204' could not be found. Attempting to find and install...
    default: Box Provider: virtualbox
    default: Box Version: >= 0
==> default: Loading metadata for box 'generic/ubuntu2204'
    default: URL: https://vagrantcloud.com/generic/ubuntu2204
==> default: Adding box 'generic/ubuntu2204' (v4.2.12) for provider: virtualbox
    default: Downloading: https://vagrantcloud.com/generic/boxes/ubuntu2204/versions/4.2.12/providers/virtualbox.box


PS C:\Users\dhqkg> wget http://twoseven.kr/weekend_0218/docker_vm/Vagrantfile -Outfile Vagrantfile
PS C:\Users\dhqkg> wget http://twoseven.kr/weekend_0218/docker_vm/docker_install.sh -Outfile docker_install.sh
PS C:\Users\dhqkg> wget http://twoseven.kr/weekend_0218/docker_vm/ssh_conf.sh -Outfile ssh_conf.sh

PS C:\Users\dhqkg\week\docker_ubuntu> cat .\Vagrantfile
Vagrant.configure("2") do |config|
        # docker_server for docker
        config.vm.define "docker_ubuntu" do |cfg|
                cfg.vm.box = "generic/ubuntu2204"
                cfg.vm.provider "virtualbox" do |vb|
                        vb.name = "docker"
                        vb.cpus = 2
                        vb.memory = 2048
                        vb.gui = false
                end
                cfg.vm.host_name = "ubuntu.example.com"
                cfg.vm.network "private_network", ip: "192.168.57.10"
                cfg.vm.provision "shell", path: "ssh_conf.sh", privileged: true
               # cfg.vm.provision "shell", path: "add_hosts.sh"
               # cfg.vm.provision "shell", path: "docker_install.sh", privileged: true
        end
end



PS C:\Users\dhqkg\week\docker_ubuntu> vagrant up
Bringing machine 'docker_ubuntu' up with 'virtualbox' provider...
==> docker_ubuntu: Importing base box 'generic/ubuntu2204'...
==> docker_ubuntu: Matching MAC address for NAT networking...
==> docker_ubuntu: Checking if box 'generic/ubuntu2204' version '4.2.12' is up to date...
==> docker_ubuntu: Setting the name of the VM: docker
==> docker_ubuntu: Clearing any previously set network interfaces...
==> docker_ubuntu: Preparing network interfaces based on configuration...
    docker_ubuntu: Adapter 1: nat
    docker_ubuntu: Adapter 2: hostonly
==> docker_ubuntu: Forwarding ports...
    docker_ubuntu: 22 (guest) => 2222 (host) (adapter 1)
==> docker_ubuntu: Running 'pre-boot' VM customizations...
==> docker_ubuntu: Booting VM...
==> docker_ubuntu: Waiting for machine to boot. This may take a few minutes...
    docker_ubuntu: SSH address: 127.0.0.1:2222
    docker_ubuntu: SSH username: vagrant
    docker_ubuntu: SSH auth method: private key
    docker_ubuntu: Warning: Connection reset. Retrying...
    docker_ubuntu: Warning: Connection aborted. Retrying...
    docker_ubuntu:
    docker_ubuntu: Vagrant insecure key detected. Vagrant will automatically replace
    docker_ubuntu: this with a newly generated keypair for better security.
    docker_ubuntu:
    docker_ubuntu: Inserting generated public key within guest...
    docker_ubuntu: Removing insecure key from the guest if it's present...
    docker_ubuntu: Key inserted! Disconnecting and reconnecting using new SSH key...
==> docker_ubuntu: Machine booted and ready!
==> docker_ubuntu: Checking for guest additions in VM...
==> docker_ubuntu: Setting hostname...
==> docker_ubuntu: Configuring and enabling network interfaces...
==> docker_ubuntu: Running provisioner: shell...
    docker_ubuntu: Running: C:/Users/dhqkg/AppData/Local/Temp/vagrant-shell20230218-14692-birv4q.sh
```

#### putty로 접속
- putty / securecrt / xshell 등 원격접속 사용  -> https://www.putty.org/  -> 다운로드64-bit x86: putty.exe
- 192.168.57.10로 접속
- id, pwd : vagrant

#### vagrant로 접속
```shell
-- 공개키로 접속함 (ssgd_config shell로 설정해놓음) 등록된 key로 접속이 되는 것.
PS C:\Users\dhqkg\week\docker_ubuntu> vagrant ssh
vagrant@ubuntu:~$
``

### ubuntu docker 설치 
- https://docs.docker.com/engine/install/ubuntu/
- Ubuntu Jammy 22.04 (LTS)

```shell

vagrant@ubuntu:~$ sudo whoami
root
vagrant@ubuntu:~$ sudo apt-get update
vagrant@ubuntu:~$ sudo apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

vagrant@ubuntu:~$ sudo mkdir -m 0755 -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg


sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 오류해결 : https://sup2is.tistory.com/91
```

### 도커를 사용하는 이유? 

- 도커는 컨테이너 가상화 기술을 제공하여 애플리케이션을 가볍고 빠르게 배포 및 실행할 수 있도록 도와줍니다. <br>
- 이를 통해 다음과 같은 이점을 얻을 수 있습니다.

##### 1) 일관성 있는 환경 구성
- 도커는 애플리케이션을 동일한 환경에서 실행하므로, 시스템 구성이 달라지더라도 애플리케이션의 동작이 예측 가능합니다.  <br>
- 이를 통해 애플리케이션 배포와 관리를 단순화할 수 있습니다.

##### 2) 빠른 배포
- 도커는 애플리케이션을 컨테이너로 패키징하므로, 이를 호스트 운영체제와 독립적으로 배포할 수 있습니다.  <br>
- 이를 통해 배포 속도를 높이고, 문제가 발생했을 때 롤백이 빠르게 이루어질 수 있습니다.

##### 3) 리소스 효율적 사용
- 도커는 가상화 기술을 사용하기 때문에, 가상 머신보다 더 가볍고 작은 운영체제 이미지를 사용하여 리소스를 효율적으로 사용할 수 있습니다.  <br>
- 이를 통해 더 많은 애플리케이션을 동시에 실행할 수 있습니다.

#####  4) 확장성
- 도커는 애플리케이션을 컨테이너로 패키징하고 배포하므로, 애플리케이션의 수평적 확장이 쉽습니다.  <br>
- 이를 통해 애플리케이션의 성능을 높이고, 사용량에 따라 리소스를 증감시킬 수 있습니다.

#### docker 실행
docker(client) ----- docker.sock(소켓) ------> dockerd
도커 소켓 파일 : /var/run/docker.sock 이걸 통하여 docker daemon에 접속한다. 

그룹권한 적용 -> 새로 로그인하면 적용됨

``` shell
vagrant@ubuntu:~$ sudo usermod -aG docker vagrant
vagrant@ubuntu:~$ groups
login as: vagrant
vagrant@192.168.57.10's password:
Last login: Sat Feb 18 02:41:37 2023 from 192.168.57.1
vagrant@ubuntu:~$ groups
vagrant docker

vagrant@ubuntu:~$ docker images
REPOSITORY    TAG       IMAGE ID       CREATED         SIZE
hello-world   latest    feb5d9fea6a5   17 months ago   13.3kB

# 도커 재시작 
vagrant@ubuntu:~$ sudo systemctl restart docker 
vagrant@ubuntu:~$ docker ps -a
CONTAINER ID   IMAGE         COMMAND    CREATED          STATUS                      PORTS     NAMES
b1dc9a09cc21   hello-world   "/hello"   49 minutes ago   Exited (0) 49 minutes ago             objective_mayer

# nginx 다운로드 
-  25개씩 찾아줌 -> 100개
-  docker 구조는 하나의 파일이 아니고 기능별로 layer구조로 되어 있어 병렬로 다운로드 받아짐 => 더 빨리 받을 수 있음. 

vagrant@ubuntu:~$ docker search nginx --limit 100
vagrant@ubuntu:~$ docker pull nginx 
Using default tag: latest
latest: Pulling from library/nginx
bb263680fed1: Pull complete
258f176fd226: Pull complete
a0bc35e70773: Pull complete
077b9569ff86: Pull complete
3082a16f3b61: Pull complete
7e9b29976cce: Pull complete
Digest: sha256:6650513efd1d27c1f8a5351cbd33edf85cc7e0d9d0fcb4ffb23d8fa89b601ba8
Status: Downloaded newer image for nginx:latest
docker.io/library/nginx:latest

- 확인
vagrant@ubuntu:~$ docker images
REPOSITORY    TAG       IMAGE ID       CREATED         SIZE
nginx         latest    3f8a00f137a0   8 days ago      142MB
hello-world   latest    feb5d9fea6a5   17 months ago   13.3kB

vagrant@ubuntu:~$ sudo find /var/lib/docker -name '3f8a00f137a0*'
/var/lib/docker/image/overlay2/imagedb/content/sha256/3f8a00f137a0d2c8a2163a09901e28e2471999fde4efc2f9570b91f1c30acf94

- 실행 
vagrant@ubuntu:~$ docker run nginx:latest

- 컨테이너 메타데이터 확인 

vagrant@ubuntu:~$ curl http://172.17.0.2

- 백그라운드 실행 
vagrant@ubuntu:~$ : docker run  -d -p 9900:80 --name=mynginx nginx

vagrant@ubuntu:~$ sudo iptables -t nat -L -n
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination
DOCKER     all  --  0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL

Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
DOCKER     all  --  0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
MASQUERADE  all  --  172.17.0.0/16        0.0.0.0/0

Chain DOCKER (2 references)
target     prot opt source               destination
RETURN     all  --  0.0.0.0/0            0.0.0.0/0

```


